# Audit 2025-01: Wien ÖPNV Feed

## Zusammenfassung
- Alle bestehenden Unit-Tests (233) laufen erfolgreich durch und decken zentrale Feed- und Provider-Pfade ab.
- Die Feed-Erzeugung arbeitet ausschließlich mit den Repository-Caches der Provider; Netzwerkzugriffe sind für den Feed-Build nicht erforderlich.
- Geheimnisse wie das VOR Access ID werden beim Logging zuverlässig maskiert.
- Stationsdaten werden konsistent gepflegt; Kollisionen in Aliasen werden erkannt und protokolliert.

## Details
### Stabilität und Zuverlässigkeit
- `_collect_items` priorisiert Cache-Provider und führt Netz-Zugriffe parallel mit Timeout-Schutz aus, sodass Ausfälle einzelner Provider den Build nicht blockieren.【F:src/build_feed.py†L464-L530】
- Tests decken Fehlerszenarien ab: leere Caches führen zu Warnungen, der Feed-Build kann ohne Netzwerk durchlaufen, und `read_cache` wird für alle Provider abgefragt.【F:tests/test_build_feed_cache.py†L35-L114】
- Environment-Flags deaktivieren Provider zuverlässig; Whitespaces und Groß-/Kleinschreibung werden abgefangen.【F:tests/test_collect_items_env.py†L28-L78】

### Datenalterung und Feed-Inhalte
- `_drop_old_items` entfernt automatisch abgelaufene oder zu alte Items und berücksichtigt `first_seen`, um zeitlose Meldungen zu begrenzen.【F:src/build_feed.py†L533-L589】
- `_identity_for_item` erzeugt deterministische Kennungen, sodass Deduplizierung und State-Abgleich stabil bleiben.【F:src/build_feed.py†L420-L457】

### Stationsabgleich
- Alias-Kollisionen im Stationsverzeichnis lösen Warnungen aus, was bei Datenpflege auf Inkonsistenzen hinweist.【F:tests/test_station_alias_collision.py†L7-L33】
- Stations-Metadaten enthalten valide VZG-Kilometerangaben und werden durch Tests vor unbeabsichtigten Änderungen geschützt.【F:tests/test_stations_metadata.py†L1-L46】

### Sicherheit und Geheimnisse
- Pfadangaben werden auf Repository-verträgliche Verzeichnisse beschränkt; Tests verhindern eine Ausgabe außerhalb des Whitelists.【F:src/build_feed.py†L26-L71】【F:tests/test_path_guard.py†L25-L51】
- Das VOR Access ID wird aus den Umgebungsvariablen geladen und bei allen Log-Ausgaben maskiert, um Leaks zu verhindern.【F:src/providers/vor.py†L271-L416】

### APIs und Feed-Befüllung
- Der Feed nutzt ausschließlich die zwischengespeicherten Provider-Daten; Tests stellen sicher, dass fehlende Caches sauber behandelt werden.【F:tests/test_build_feed_cache.py†L35-L114】
- Der WL-Provider filtert nicht mehr aktive Störungen und bereitet Linien-/Haltestellenbezüge konsistent auf.【F:src/providers/wl_fetch.py†L344-L470】

## Empfohlene nächste Schritte
- Aktuell keine kritischen Maßnahmen erforderlich; regelmäßiger Testlauf (z. B. via CI) beibehalten.
- Bei Änderungen an Provider-Schnittstellen sollten ergänzende Tests für neue Felder ergänzt werden, um die hohe Abdeckung beizubehalten.
