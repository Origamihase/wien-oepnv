# Audit 2025-01-04: Wien ÖPNV Feed

## Zusammenfassung
- Die Pipeline schützt alle aus dem Dateisystem geladenen Pfade konsequent über eine Whitelist und erzwingt aussagekräftiges Logging, wenn ungültige Werte eingehen.【F:src/build_feed.py†L26-L105】
- Cache-Provider werden deterministisch sequenziell und Netzwerk-Provider parallel mit Timeout überwacht – Tests stellen sicher, dass Hänger nicht den gesamten Feed-Aufbau blockieren.【F:src/build_feed.py†L469-L538】【F:tests/test_collect_items_timeout.py†L29-L92】
- Cache-Lese- und Schreibvorgänge sind atomar umgesetzt; Fehlerzustände werden sauber geloggt.【F:src/utils/cache.py†L1-L104】
- HTTP-Zugriffe nutzen wiederverwendete Sessions mit Retry-Backoff, und alle untersuchten Provider erzwingen Timeouts pro Request.【F:src/utils/http.py†L1-L35】【F:src/providers/wl_fetch.py†L303-L340】【F:src/providers/vor.py†L389-L239】
- Die Tageslimit-Logik des VOR-Providers ist robust gegen parallele Zugriffe; Unit-Tests simulieren Lock-Übernahmen und Fehlerfälle.【F:src/providers/vor.py†L133-L239】【F:tests/test_vor_request_limit.py†L27-L189】

## Testabdeckung und Checks
- ✅ `pytest` (257 Tests) – alle Szenarien bestanden.【a56960†L1-L26】
- ✅ `python -m compileall src` – bestätigt syntaktische Integrität aller Module.【b77c5e†L1-L4】

## Bewertung der Codebasis
### Pfad- und Konfigurationssicherheit
`_resolve_env_path` erlaubt nur Pfade innerhalb von `docs/`, `data/` oder `log/` und ersetzt ungültige Werte automatisch durch geprüfte Defaults. Tests verifizieren, dass Feed-Ausgaben und State-Dateien nicht außerhalb des Repos abgelegt werden können.【F:src/build_feed.py†L26-L105】【F:tests/test_path_guard.py†L25-L51】

### Datenquellen & Parallelität
Die Sammlung der Meldungen trennt Cache- von Netzwerk-Providern: Caches werden sequenziell gelesen, Netzwerk-Zugriffe laufen parallel mit `as_completed`, Timeout-Behandlung sowie Cancel-Futures verhindern Zombie-Threads. Tests decken sowohl Timeout- als auch Reihenfolgen-Szenarien ab.【F:src/build_feed.py†L469-L538】【F:tests/test_collect_items_timeout.py†L29-L92】

### Persistenz & Resilienz
Cache-Dateien werden über `tempfile.mkstemp` geschrieben und via `os.replace` atomar aktualisiert. Der VOR-Request-Zähler sperrt über Lock-Dateien, entfernt veraltete Locks und stellt sicher, dass Zählerstände bei Fehlern erhalten bleiben.【F:src/utils/cache.py†L63-L104】【F:src/providers/vor.py†L133-L239】【F:tests/test_vor_request_limit.py†L62-L189】

### HTTP-Robustheit
Gemeinsame HTTP-Sessions nutzen konfigurierbare Retry-Optionen; Provider erzwingen Request-Timeouts und validieren JSON-Antworten. Fehlerhafte Antworten führen zu Logging statt unkontrollierten Ausnahmen.【F:src/utils/http.py†L11-L35】【F:src/providers/wl_fetch.py†L303-L340】【F:src/providers/vor.py†L389-L239】

### Feed-Generierung & Tests
Tests decken Cache-Ausfälle, fehlende Provider und Fallbacks beim Formatieren ab; dadurch ist nachvollziehbar, dass jede Code-Pfad-Entscheidung einen Zweck erfüllt und abgesichert ist.【F:tests/test_build_feed_cache.py†L35-L138】

## Handlungsempfehlungen
1. **CI-Härtung für Nebenwerkzeuge** – Ergänzen Sie automatisierte Läufe für `python -m compileall` oder optional statische Checks (z. B. `ruff`, `mypy`), um syntaktische oder stilistische Regressions frühzeitig zu erkennen. (Der manuelle Check verlief erfolgreich, ist aber noch nicht in den Tests verankert.)
2. **Konfigurations-Validierung dokumentieren** – Die Pfad-Whitelist und Log-Fallbacks funktionieren korrekt, könnten aber im README oder in bestehenden Audit-Dokumenten kurz dokumentiert werden, damit Administrator:innen Fehlschläge schneller einordnen können.
3. **Monitoring der VOR-Request-Locks** – Obwohl veraltete Locks bereinigt werden, lohnt es sich, in Produktion regelmäßig auf liegengebliebene `.lock`-Dateien zu prüfen, falls `REQUEST_LOCK_TIMEOUT_SEC` auf `0` gesetzt wird (dann greift die Übernahme-Logik nicht).

Insgesamt zeigt der Querschnitt durch Tests und Implementierung keine akuten Fehler oder ineffizienten Hotspots. Die vorhandenen Mechanismen erfüllen erkennbar ihren Zweck; weitere Maßnahmen sind rein präventiv.
