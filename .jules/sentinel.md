## 2024-05-23 - Stored XSS in RSS Feed Generation
**Vulnerability:** The RSS feed generator (`src/build_feed.py`) was taking plain text descriptions (generated by `html_to_text`) and wrapping them in `CDATA` blocks for the `content:encoded` element without escaping. Since `html_to_text` unescapes HTML entities (e.g., `&lt;script&gt;` becomes `<script>`), malicious input could be rendered as executable HTML/JavaScript by RSS readers.
**Learning:** `html_to_text` produces "text" for human consumption, but "text" containing `<` and `>` characters is dangerous when placed into an HTML context (like `content:encoded` in RSS) even if wrapped in `CDATA`. `CDATA` only protects the XML parser, not the downstream HTML renderer.
**Prevention:** Always use `html.escape()` on text content before placing it into `content:encoded` or similar HTML-capable fields in RSS feeds, even if the content is nominally "plain text" and even if using `CDATA`.

## 2024-05-24 - Unvalidated URL Configuration via Environment Variables
**Vulnerability:** The application allowed configuring external provider URLs (e.g., `WL_RSS_URL`) via environment variables without validation. This could potentially enable SSRF (Server-Side Request Forgery) attacks or local file access if a malicious user could control the environment (e.g., setting `WL_RSS_URL=file:///etc/passwd`).
**Learning:** Even "internal" configuration variables should be treated as untrusted input if they control network requests. Relying on implicit trust for environment variables is risky in environments where they might be injected or misconfigured.
**Prevention:** Explicitly validate all user-configurable URLs using a strict allowlist of schemes (e.g., `http`, `https`). Implemented `validate_http_url` in `src/utils/http.py` and applied it to all provider configurations.

## 2024-12-25 - Insecure Temporary File Creation
**Vulnerability:** The feed builder (`src/build_feed.py`) was creating temporary files using `out_path.with_suffix('.tmp')` before atomically replacing the target file. This predictable filename pattern (e.g., `feed.tmp` for `feed.xml`) in a shared directory (`/tmp` or similar) is vulnerable to symlink attacks or race conditions (CWE-377), where an attacker could pre-create the file or a link to a sensitive file.
**Learning:** Predictable temporary filenames are a security risk, even in build scripts. Additionally, `tempfile.mkstemp` is secure but creates files with restrictive permissions (`0o600`), which breaks functionality for public artifacts like RSS feeds that need to be world-readable (`0o644`).
**Prevention:** Always use `tempfile.mkstemp` (or `NamedTemporaryFile` with `delete=False`) for creating temporary files to ensure uniqueness and security. When the file is intended for public consumption, explicitly set permissions (e.g., `os.chmod(path, 0o644)`) before moving it into place.

## 2025-05-25 - Redundant and Inconsistent Secure File Writing Logic
**Vulnerability:** The secure file writing pattern (using `mkstemp`, `fsync`, `chmod`, `rename`) was duplicated across multiple modules (`src/build_feed.py`, `src/utils/cache.py`, `src/feed/reporting.py`). Code duplication increases the risk of subtle inconsistencies (e.g., forgetting `fsync` or using wrong permissions) and makes it harder to audit or patch security flaws globally.
**Learning:** Security-critical logic such as atomic file writing should be centralized in a single, well-tested utility to ensure consistent application of security best practices (defense in depth).
**Prevention:** Refactored the codebase to use a centralized `atomic_write` context manager in `src/utils/files.py`. This utility encapsulates all steps for secure file creation, including strict permission defaults and atomic replacement.

## 2025-05-25 - Argument Injection in Sitemap Generation
**Vulnerability:** The sitemap generator (`scripts/generate_sitemap.py`) passed the file path directly to `git log` via `subprocess` without using the `--` separator. This meant that a file named like a command-line flag (e.g., `-p` or `--help`) could be interpreted as an option by `git`, potentially leading to unexpected behavior or error leakage (CWE-88).
**Learning:** When passing untrusted or partially trusted input (like filenames from a repository) to command-line tools via `subprocess`, always use the `--` separator to explicitly delimit options from positional arguments.
**Prevention:** Updated `scripts/generate_sitemap.py` to invoke `git log` with the `--` separator: `["git", "log", ..., "--", str(path)]`.

## 2025-05-25 - Denial of Service via Recursion in Serializer
**Vulnerability:** The utility `serialize_for_cache` (used for caching external data) was vulnerable to infinite recursion if passed a data structure with circular references. This could lead to a `RecursionError` and crash the application (Denial of Service). While input currently comes from trusted providers (parsed JSON), future changes or new providers could inadvertently introduce cycles.
**Learning:** Recursive functions processing generic input must always include cycle detection or depth limits to prevent stack overflows, even if the current data sources are believed to be acyclic.
**Prevention:** Updated `src/utils/serialize.py` to track visited object IDs during recursion and raise a `ValueError` if a cycle is detected, mirroring the behavior of `json.dumps`.

## 2025-05-26 - Credential Leakage in Redirect Error Messages
**Vulnerability:** The `_check_redirect_security` function in `src/utils/http.py` validated redirect URLs but, upon finding an unsafe URL (e.g., one with embedded credentials), raised a `ValueError` containing the unsanitized URL. This exposed sensitive credentials (e.g., `https://user:pass@host/...`) in logs and exception traces.
**Learning:** Exception messages often end up in logs. Including raw inputs (like URLs) in error messages without sanitization can leak sensitive data, even if the application correctly rejects the input.
**Prevention:** Implemented `_sanitize_url_for_error` in `src/utils/http.py` to strip credentials from URLs before including them in exception messages. Applied this to both redirect checks and DNS rebinding verification.

## 2025-10-15 - Credential Leakage in URL Parameters
**Vulnerability:** The VOR provider (`src/providers/vor.py`) was injecting the access token (`accessId`) into query parameters for every request, even when the `Authorization` header was also set. Sending credentials in URL parameters is a security risk (CWE-598) as they can be logged by proxy servers, access logs, and browser history, unlike headers which are typically encrypted in transit (HTTPS) and not logged by default.
**Learning:** Providing credentials via URL parameters should be avoided even when using HTTPS. If an API supports `Authorization` headers (Basic/Bearer), prefer that method exclusively and suppress the query parameter injection to minimize the attack surface.
**Prevention:** Updated `src/providers/vor.py` to check for the presence of the `_VOR_AUTHORIZATION_HEADER` and, if present, skip injecting the `accessId` into the query parameters.

## 2025-10-16 - Sensitive Query Parameters Leaking in Error Logs
**Vulnerability:** While `_sanitize_url_for_error` correctly stripped Basic Auth credentials from URLs, it failed to redact sensitive query parameters (e.g., `accessId`, `token`). If a redirect or network error occurred involving a URL with these parameters, the full URL—including the secret—would be logged in the exception message, bypassing log masking efforts.
**Learning:** URL sanitization must address all parts of the URL where secrets typically reside, including the query string. Stripping only the "user:pass" section is insufficient when modern APIs often use query parameters for authentication keys.
**Prevention:** Enhanced `_sanitize_url_for_error` in `src/utils/http.py` to parse query strings and explicitly redact values for known sensitive keys (e.g., `accessId`, `key`, `token`) before logging.

## 2025-01-31 - XML Injection in Sitemap Generation
**Vulnerability:** `scripts/generate_sitemap.py` constructed XML using string concatenation, allowing invalid XML characters (like `&`) in `SITE_BASE_URL` to break the sitemap structure.
**Learning:** Even internal helper scripts dealing with "static" sites need proper output encoding if they handle environment variables.
**Prevention:** Use `xml.etree.ElementTree` or similar libraries for XML generation instead of manual string formatting.
