name: Test VOR API

on:
  workflow_dispatch:
  push:
    paths:
      - "src/providers/vor.py"
      - "scripts/**"
      - ".github/workflows/test-vor-api.yml"

permissions:
  contents: read

jobs:
  test:
    runs-on: ubuntu-22.04
    env:
      VOR_ACCESS_ID: ${{ secrets.VOR_ACCESS_ID }}
      VOR_BASE_URL: ${{ secrets.VOR_BASE_URL }}

    steps:
      - name: Check out repository
        uses: actions/checkout@v4

      - name: Validate required secrets
        shell: bash
        run: |
          set -euo pipefail
          if [[ -z "${VOR_ACCESS_ID:-}" || -z "${VOR_BASE_URL:-}" ]]; then
            echo "VOR_ACCESS_ID oder VOR_BASE_URL fehlt -> Tests werden übersprungen." >&2
            echo "Hinweis: In PRs aus Forks stehen Secrets nicht zur Verfügung." >&2
            exit 78
          fi

      - name: Set up Python
        if: ${{ success() }}
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        if: ${{ success() }}
        run: pip install -r requirements.txt

      - name: Smoke test VOR endpoint
        if: ${{ success() }}
        shell: bash
        run: |
          set -euo pipefail
          code=$(curl -sS -o /dev/null -w "%{http_code}" -G \
            "${VOR_BASE_URL}location.name" \
            --data-urlencode "input=Wien Hauptbahnhof" \
            --data-urlencode "format=json" \
            --data-urlencode "accessId=${VOR_ACCESS_ID}")
          echo "location.name -> HTTP ${code}"
          test "$code" = "200"

      - name: Run pytest
        if: ${{ success() }}
        run: pytest -q
